<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Custom meta events | DryWetMIDI </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Custom meta events | DryWetMIDI ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="a_custom_meta_event">
<h1 id="custom-meta-events">Custom meta events</h1>

<p>Meta events specify non-MIDI information useful to specific application. As with <a class="xref" href="Custom-chunks.html">custom chunks</a>, future or custom meta events may be designed. Format of meta events allows to programs which don't know about these new events to skip them without reading process failure. DryWetMIDI allows you to implement custom meta events which can be written to a MIDI file <a class="xref" href="../../api/Melanchall.DryWetMidi.Core.TrackChunk.html">track chunk</a> and be read from it.</p>
<p>For example, let's create an event which will hold an image. Custom meta event must be derived from the <a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MetaEvent.html">MetaEvent</a> and must implement four abstract methods:</p>
<ul>
<li><a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MetaEvent.html#Melanchall_DryWetMidi_Core_MetaEvent_ReadContent_Melanchall_DryWetMidi_Core_MidiReader_Melanchall_DryWetMidi_Core_ReadingSettings_System_Int32_">ReadContent</a>;</li>
<li><a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MetaEvent.html#Melanchall_DryWetMidi_Core_MetaEvent_WriteContent_Melanchall_DryWetMidi_Core_MidiWriter_Melanchall_DryWetMidi_Core_WritingSettings_">WriteContent</a>;</li>
<li><a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MetaEvent.html#Melanchall_DryWetMidi_Core_MetaEvent_GetContentSize_Melanchall_DryWetMidi_Core_WritingSettings_">GetContentSize</a>;</li>
<li><a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MidiEvent.html#Melanchall_DryWetMidi_Core_MidiEvent_CloneEvent">CloneEvent</a>.</li>
</ul>
<p>Also a class must have parameterless constructor.</p>
<pre><code class="lang-csharp">public sealed class ImageEvent : MetaEvent
{
    public ImageEvent()
        : base()
    {
    }

    public ImageEvent(Image image)
        : this()
    {
        Image = image;
    }

    public Image Image { get; set; }

    protected override void ReadContent(MidiReader reader, ReadingSettings settings, int size)
    {
        throw new NotImplementedException();
    }

    protected override void WriteContent(MidiWriter writer, WritingSettings settings)
    {
        throw new NotImplementedException();
    }

    protected override int GetContentSize(WritingSettings settings)
    {
        throw new NotImplementedException();
    }

    protected override MidiEvent CloneEvent()
    {
        throw new NotImplementedException();
    }
}
</code></pre>
<p>Now we implement methods mentioned above. Start from the <code>ReadContent</code>:</p>
<pre><code class="lang-csharp">protected override void ReadContent(MidiReader reader, ReadingSettings settings, int size)
{
    if (size == 0)
        return;

    var imageBytes = reader.ReadBytes(size);

    var converter = new ImageConverter();
    Image = (Image)converter.ConvertFrom(imageBytes);
}
</code></pre>
<p>Every meta event contains size of the event's content. Size is passed to <code>ReadContent</code> through <code>size</code> parameter so we know how much bytes we need to read in order to restore an image.</p>
<p>Now let's implement <code>WriteContent</code>:</p>
<pre><code class="lang-csharp">protected override void WriteContent(MidiWriter writer, WritingSettings settings)
{
    if (Image == null)
        return;

    var converter = new ImageConverter();
    var imageBytes = (byte[])converter.ConvertTo(Image, typeof(byte[]));

    writer.WriteBytes(imageBytes);
}
</code></pre>
<p>Now we have to implement <code>GetContentSize</code>:</p>
<pre><code class="lang-csharp">protected override int GetContentSize(WritingSettings settings)
{
    if (Image == null)
        return 0;

    var converter = new ImageConverter();
    var imageBytes = (byte[])converter.ConvertTo(Image, typeof(byte[]));

    return imageBytes.Length;
}
</code></pre>
<p>Value returned by this method will be written to the event as its content size.</p>
<p>To support cloning of an event we need to implement <code>CloneEvent</code> method:</p>
<pre><code class="lang-csharp">public override MidiEvent CloneEvent()
{
    return new ImageEvent(Image?.Clone() as Image);
}
</code></pre>
<p>Custom meta event is completely implemented. In order to read and write it we must assign status byte to the event. You have to pick value from the <strong>[0x5F; 0x7E]</strong> range which will be the status byte of your event type. You can get status bytes of standard meta events via <a class="xref" href="../../api/Melanchall.DryWetMidi.Core.MetaEvent.html#Melanchall_DryWetMidi_Core_MetaEvent_GetStandardMetaEventStatusBytes">MetaEvent.GetStandardMetaEventStatusBytes</a>. See code sample below to know how to read and write custom meta event:</p>
<pre><code class="lang-csharp">// Define collection of custom meta event types along with
// corresponding status bytes.

var customMetaEventTypes = new EventTypesCollection
                {
                    { typeof(ImageEvent), 0x5F }
                };

// Write an image event to an existing file.

var file = MidiFile.Read(&quot;My Great Song.mid&quot;);

var trackChunk = file.Chunks.OfType&lt;TrackChunk&gt;().First();

var image = Image.FromFile(&quot;My image.jpg&quot;);
var imageEvent = new ImageEvent(image);
trackChunk.Events.Add(imageEvent);

file.Write(&quot;My Great Song.mid&quot;,
            true,
            MidiFileFormat.MultiTrack,
            new WritingSettings
            {
                CustomMetaEventTypes = customMetaEventTypes
            });

// Read a MIDI file with ImageEvent inside.
//
// Note that if you don't specify custom meta event through CustomMetaEventTypes
// property of the ReadingSettings it will be read as UnknownMetaEvent.

var updatedFile = MidiFile.Read(
    &quot;My Great Song.mid&quot;,
    new ReadingSettings
    {
        CustomMetaEventTypes = customMetaEventTypes
    });
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            2022 / Generated by <a href="https://dotnet.github.io/docfx">DocFX</a>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
